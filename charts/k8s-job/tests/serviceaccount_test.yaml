suite: serviceaccount tests
templates:
  - serviceaccount.yaml
tests:
  - it: should not render when no jobs are defined
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when job is disabled
    set:
      jobs:
        my-job:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when serviceAccount.create is false
    set:
      jobs:
        my-job:
          enabled: true
          serviceAccount:
            create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render serviceaccount when job is enabled
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount

  - it: should set correct serviceaccount name
    release:
      name: test-release
    set:
      jobs:
        deploy-lambda:
          enabled: true
          command: ["npm"]
          args: ["deploy"]
    asserts:
      - equal:
          path: metadata.name
          value: test-release-k8s-job-deploy-lambda

  - it: should set ArgoCD annotations at sync-wave 0
    set:
      jobDefaults:
        argocd:
          hook: PreSync
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
    asserts:
      - equal:
          path: metadata.annotations["argocd.argoproj.io/hook"]
          value: PreSync
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "0"

  - it: should set custom serviceaccount annotations
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          serviceAccount:
            annotations:
              eks.amazonaws.com/role-arn: arn:aws:iam::123456789:role/my-role
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: arn:aws:iam::123456789:role/my-role

  - it: should render multiple serviceaccounts for multiple jobs
    set:
      jobs:
        job-one:
          enabled: true
          command: ["echo"]
          args: ["one"]
        job-two:
          enabled: true
          command: ["echo"]
          args: ["two"]
    asserts:
      - hasDocuments:
          count: 2

  - it: should have correct labels
    release:
      name: test-release
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: k8s-job
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: test-release
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: my-job
