suite: external-secrets tests
templates:
  - external-secrets.yaml
tests:
  - it: should not render when no jobs are defined
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when job is disabled
    set:
      jobs:
        my-job:
          enabled: false
          externalSecret:
            enabled: true
            dataFrom:
              regexp: ".*"
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when externalSecret is disabled
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when externalSecret is not configured
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
    asserts:
      - hasDocuments:
          count: 0

  - it: should render ExternalSecret when enabled with regexp
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            dataFrom:
              regexp: "/cf2/production/.*"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ExternalSecret

  - it: should set correct ExternalSecret name from job fullname
    release:
      name: test-release
    set:
      jobs:
        deploy-lambda:
          enabled: true
          command: ["npm"]
          args: ["deploy"]
          externalSecret:
            enabled: true
            dataFrom:
              regexp: ".*"
    asserts:
      - equal:
          path: metadata.name
          value: test-release-k8s-job-deploy-lambda
      - equal:
          path: spec.target.name
          value: test-release-k8s-job-deploy-lambda

  - it: should allow custom ExternalSecret name
    release:
      name: test-release
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            name: custom-secret-name
            dataFrom:
              regexp: ".*"
    asserts:
      - equal:
          path: metadata.name
          value: custom-secret-name
      - equal:
          path: spec.target.name
          value: custom-secret-name

  - it: should use default secretStoreRef
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            dataFrom:
              regexp: ".*"
    asserts:
      - equal:
          path: spec.secretStoreRef.name
          value: aws-parameter-store-cluster
      - equal:
          path: spec.secretStoreRef.kind
          value: ClusterSecretStore

  - it: should allow custom secretStoreRef
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            secretStoreRef:
              name: custom-secret-store
              kind: SecretStore
            dataFrom:
              regexp: ".*"
    asserts:
      - equal:
          path: spec.secretStoreRef.name
          value: custom-secret-store
      - equal:
          path: spec.secretStoreRef.kind
          value: SecretStore

  - it: should set default policies
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            dataFrom:
              regexp: ".*"
    asserts:
      - equal:
          path: spec.target.creationPolicy
          value: Owner
      - equal:
          path: spec.target.deletionPolicy
          value: Retain
      - equal:
          path: spec.refreshInterval
          value: "0"
      - equal:
          path: spec.refreshPolicy
          value: OnChange

  - it: should allow custom policies
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            refreshInterval: "1h"
            refreshPolicy: Always
            creationPolicy: Merge
            deletionPolicy: Delete
            dataFrom:
              regexp: ".*"
    asserts:
      - equal:
          path: spec.refreshInterval
          value: "1h"
      - equal:
          path: spec.refreshPolicy
          value: Always
      - equal:
          path: spec.target.creationPolicy
          value: Merge
      - equal:
          path: spec.target.deletionPolicy
          value: Delete

  - it: should set dataFrom with regexp only
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            dataFrom:
              regexp: "/cf2/production/lambda/.*"
    asserts:
      - equal:
          path: spec.dataFrom[0].find.name.regexp
          value: "/cf2/production/lambda/.*"
      - isNull:
          path: spec.dataFrom[0].find.path

  - it: should set dataFrom with path and regexp
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            dataFrom:
              path: /cf2/production/lambda/
              regexp: ".*"
    asserts:
      - equal:
          path: spec.dataFrom[0].find.path
          value: /cf2/production/lambda/
      - equal:
          path: spec.dataFrom[0].find.name.regexp
          value: ".*"

  - it: should set dataFrom with rewrite
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            dataFrom:
              path: /cf2/production/lambda/
              regexp: ".*"
              rewrite:
                source: "/cf2/production/lambda/(.*)"
                target: "$1"
    asserts:
      - equal:
          path: spec.dataFrom[0].rewrite[0].regexp.source
          value: "/cf2/production/lambda/(.*)"
      - equal:
          path: spec.dataFrom[0].rewrite[0].regexp.target
          value: "$1"

  - it: should not include rewrite when not configured
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            dataFrom:
              regexp: ".*"
    asserts:
      - isNull:
          path: spec.dataFrom[0].rewrite

  - it: should set ArgoCD sync-wave annotation
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            dataFrom:
              regexp: ".*"
    asserts:
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "-1"

  - it: should have correct labels
    release:
      name: test-release
    set:
      jobs:
        my-job:
          enabled: true
          command: ["echo"]
          args: ["hello"]
          externalSecret:
            enabled: true
            dataFrom:
              regexp: ".*"
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: k8s-job
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: test-release
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: my-job

  - it: should render multiple ExternalSecrets for multiple jobs
    set:
      jobs:
        job-one:
          enabled: true
          command: ["echo"]
          args: ["one"]
          externalSecret:
            enabled: true
            dataFrom:
              regexp: "/path/one/.*"
        job-two:
          enabled: true
          command: ["echo"]
          args: ["two"]
          externalSecret:
            enabled: true
            dataFrom:
              regexp: "/path/two/.*"
    asserts:
      - hasDocuments:
          count: 2
