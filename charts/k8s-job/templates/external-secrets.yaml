{{- range $jobName, $jobConfig := .Values.jobs }}
{{- if $jobConfig.enabled }}
{{- $mergedJson := include "k8s-job.mergeJobConfig" (dict "root" $ "jobName" $jobName "jobConfig" $jobConfig) }}
{{- $merged := $mergedJson | fromJson }}
{{- if $merged.externalSecret.enabled }}
{{- $fullname := include "k8s-job.jobFullname" (dict "root" $ "jobName" $jobName) }}
{{- $es := $merged.externalSecret }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $es.name | default $fullname }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
  labels:
    {{- include "k8s-job.labels" $ | nindent 4 }}
    app.kubernetes.io/component: {{ $jobName }}
spec:
  refreshInterval: {{ $es.refreshInterval | default "0" | quote }}
  refreshPolicy: {{ $es.refreshPolicy | default "OnChange" }}
  secretStoreRef:
    name: {{ $es.secretStoreRef.name | default "aws-parameter-store-cluster" }}
    kind: {{ $es.secretStoreRef.kind | default "ClusterSecretStore" }}
  target:
    name: {{ $es.name | default $fullname }}
    creationPolicy: {{ $es.creationPolicy | default "Owner" }}
    deletionPolicy: {{ $es.deletionPolicy | default "Retain" }}
  dataFrom:
    - find:
        {{- if $es.dataFrom.path }}
        path: {{ $es.dataFrom.path }}
        {{- end }}
        name:
          regexp: {{ $es.dataFrom.regexp | quote }}
      {{- if $es.dataFrom.rewrite }}
      rewrite:
        - regexp:
            source: {{ $es.dataFrom.rewrite.source | quote }}
            target: {{ $es.dataFrom.rewrite.target | quote }}
      {{- end }}
{{- end }}
{{- end }}
{{- end }}
